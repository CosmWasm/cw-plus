# CosmWasm Plus

[![CircleCI](https://circleci.com/gh/CosmWasm/cosmwasm-plus/tree/master.svg?style=shield)](https://circleci.com/gh/CosmWasm/cosmwasm-plus/tree/master)

| Specification    | Crates.io                                                                                                  | Docs                                                            |
| ---------------- | ---------------------------------------------------------------------------------------------------------  | ----------------------------------------------------------------|
| cw0              | [![cw0 on crates.io](https://img.shields.io/crates/v/cw0.svg)](https://crates.io/crates/cw0)              | [![Docs](https://docs.rs/cw0/badge.svg)](https://docs.rs/cw0)    |
| cw1              | [![cw1 on crates.io](https://img.shields.io/crates/v/cw1.svg)](https://crates.io/crates/cw1)              | [![Docs](https://docs.rs/cw1/badge.svg)](https://docs.rs/cw1)    |
| cw2              | [![cw2 on crates.io](https://img.shields.io/crates/v/cw2.svg)](https://crates.io/crates/cw2)              | [![Docs](https://docs.rs/cw2/badge.svg)](https://docs.rs/cw2)    |
| cw3              | [![cw3 on crates.io](https://img.shields.io/crates/v/cw3.svg)](https://crates.io/crates/cw3)              | [![Docs](https://docs.rs/cw3/badge.svg)](https://docs.rs/cw3)    |
| cw4              | [![cw4 on crates.io](https://img.shields.io/crates/v/cw4.svg)](https://crates.io/crates/cw4)              | [![Docs](https://docs.rs/cw4/badge.svg)](https://docs.rs/cw4)    |
| cw20              | [![cw20 on crates.io](https://img.shields.io/crates/v/cw20.svg)](https://crates.io/crates/cw20)          | [![Docs](https://docs.rs/cw20/badge.svg)](https://docs.rs/cw20)    |
| cw721              | [![cw721 on crates.io](https://img.shields.io/crates/v/cw721.svg)](https://crates.io/crates/cw721)      | [![Docs](https://docs.rs/cw721/badge.svg)](https://docs.rs/cw721)    |
| cw1155              | [![cw1155 on crates.io](https://img.shields.io/crates/v/cw1155.svg)](https://crates.io/crates/cw1155)      | [![Docs](https://docs.rs/cw1155/badge.svg)](https://docs.rs/cw1155)    |

| Utilities        | Crates.io                                                                                                                        | Docs                                                            |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------  | ----------------------------------------------------------------|
| cw-controllers      | [![cw-controllers on crates.io](https://img.shields.io/crates/v/cw-controllers.svg)](https://crates.io/crates/cw-controllers)             | [![Docs](https://docs.rs/cw-controllers/badge.svg)](https://docs.rs/cw-controllers)    |
| cw-multi-test       | [![cw-multi-test on crates.io](https://img.shields.io/crates/v/cw-multi-test.svg)](https://crates.io/crates/cw-multi-test)                | [![Docs](https://docs.rs/cw-multi-test/badge.svg)](https://docs.rs/cw-multi-test)    |
| cw-storage-plus     | [![cw-storage-plus on crates.io](https://img.shields.io/crates/v/cw-storage-plus.svg)](https://crates.io/crates/cw-storage-plus)          | [![Docs](https://docs.rs/cw-storage-plus/badge.svg)](https://docs.rs/cw-storage-plus)    |

| Contracts               | Download                                                                                                                      | Docs                                                                     |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------  | -------------------------------------------------------------------------|
| cw1-subkeys             | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw1_subkeys.wasm)                        | [![Docs](https://docs.rs/cw1-subkeys/badge.svg)](https://docs.rs/cw1-subkeys)    |
| cw1-whitelist           | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw1_whitelist.wasm)          | [![Docs](https://docs.rs/cw1-whitelist/badge.svg)](https://docs.rs/cw1-whitelist)    |
| cw3-fixed-multisig      | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw3_fixed_multisig.wasm)          | [![Docs](https://docs.rs/cw3-fixed-multisig/badge.svg)](https://docs.rs/cw3-fixed-multisig)    |
| cw3-flex-multisig       | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw3_flex_multisig.wasm)          | [![Docs](https://docs.rs/cw3-flex-multisig/badge.svg)](https://docs.rs/cw3-flex-multisig)    |
| cw4-group               | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw4_group.wasm)          | [![Docs](https://docs.rs/cw4-group/badge.svg)](https://docs.rs/cw4-group)    |
| cw4-stake               | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw4_stake.wasm)          | [![Docs](https://docs.rs/cw4-stake/badge.svg)](https://docs.rs/cw4-stake)    |
| cw20-atomic-swap        | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_atomic_swap.wasm)          | [![Docs](https://docs.rs/cw20-atomic-swap/badge.svg)](https://docs.rs/cw20-atomic-swap)    |
| cw20-base               | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_base.wasm)          | [![Docs](https://docs.rs/cw20-base/badge.svg)](https://docs.rs/cw20-base)    |
| cw20-bonding            | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_bonding.wasm)          | [![Docs](https://docs.rs/cw20-bonding/badge.svg)](https://docs.rs/cw20-bonding)    |
| cw20-escrow             | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_escrow.wasm)          | [![Docs](https://docs.rs/cw20-escrow/badge.svg)](https://docs.rs/cw20-escrow)    |
| cw20-ics20              | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_ics20.wasm)          | [![Docs](https://docs.rs/cw20-ics20/badge.svg)](https://docs.rs/cw20-ics20)    |
| cw20-staking            | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_staking.wasm)          | [![Docs](https://docs.rs/cw20-staking/badge.svg)](https://docs.rs/cw20-staking)    |
| cw20-merkle-airdrop     | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw20_merkle_airdrop.wasm)          | [![Docs](https://docs.rs/cw20-merkle-airdrop/badge.svg)](https://docs.rs/cw20-merkle-airdrop)    |
| cw721-base              | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw721_base.wasm)          | [![Docs](https://docs.rs/cw721-base/badge.svg)](https://docs.rs/cw721-base)    |
| cw1155-base             | [Release v0.8.1](https://github.com/CosmWasm/cosmwasm-plus/releases/download/v0.8.1/cw1155_base.wasm)          | [![Docs](https://docs.rs/cw1155-base/badge.svg)](https://docs.rs/cw1155-base)    |


This is a collection of specification and contracts designed for
use on real networks. They are designed not just as examples, but to
solve real-world use cases, and to provide a reusable basis to build
many custom contracts.

If you don't know what CosmWasm is, please check out
[our homepage](https://cosmwasm.com) and
[our documentation](https://docs.cosmwasm.com) to get more background.
We are running a [public testnet](https://github.com/CosmWasm/testnets/blob/master/coralnet/README.md)
you can use to test out any contracts.

**Warning** None of these contracts have been audited and no liability is
assumed for the use of this code. They are provided to turbo-start
your projects.

**Note** All code in pre-1.0 packages is in "draft" form, meaning it may
undergo minor changes and additions until 1.0. For example between 0.1 and
0.2 we adjusted the `Expiration` type to make the JSON representation
cleaner (before: `expires: {at_height: {height: 12345}}` after
`expires: {at_height: 12345}`)

## Specifications

The most reusable components are the various cwXYZ specifications under
`packages`. Each one defines a standard interface for different domains,
e.g. [cw20](./packages/cw20/README.md) for fungible tokens,
[cw721](./packages/cw721/README.md) for non-fungible tokens,
[cw1](./packages/cw1/README.md) for  "proxy contracts", etc.
The interface comes with a human description in the READMEs, as well
as Rust types that can be imported.

They contain no logic, but specify an interface. It shows what you
need to implement to create a compatible contracts, as well as what
interface we guarantee to any consumer of such contracts. This is
the real bonus of specifications, we can create an escrow contract that
can handle many different fungible tokens, as long as they all adhere to
the cw20 specification.

If you have ideas for new specifications or want to make enhancements to
existing spec, please [raise an issue](https://github.com/CosmWasm/cosmwasm-plus/issues)
or [create a pull request](https://github.com/CosmWasm/cosmwasm-plus/pulls) on this repo.

## Contracts

We provide sample contracts that either implement or consume these
specifications to both provide examples, and provide a basis
for code you can extend for more custom contacts, without worrying
about reinventing the wheel each time.
For example [`cw20-base`](./contracts/cw20-base) is a basic implementation
of a `cw20` compatible contract that can be imported in any custom
contract you want to build on it.

CW1 Proxy Contracts:

* [`cw1-whitelist`](./contracts/cw1-whitelist) a minimal implementation of `cw1`
mainly designed for reference.
* [`cw1-subkeys`](./contracts/cw1-subkeys) a simple, but useful implementation,
which lets us use a proxy contract to provide "allowances" for native tokens
without modifying the `bank` module.

CW3 Multisig:

* [`cw3-fixed-multisig`](./contracts/cw3-fixed-multisig) a simple implementation of the
[cw3 spec](./packages/cw3/README.md). It is a multisig with a fixed set of addresses,
created upon initialization.
Each address may have the same weight (K of N), or some may have extra voting
power. This works much like the native Cosmos SDK multisig, except that rather
than aggregating the signatures off chain and submitting the final result,
we aggregate the approvals on-chain.
* [`cw3-flex-multisig`](./contracts/cw3-flex-multisig) builds on cw3-fixed-multisig,
with a more powerful implementation of the cw3 spec. It's a multisig contract
backed by a cw4 (group) contract, which independently maintains the voter set.

CW4 Group:

* [`cw4-group`](./contracts/cw4-group) a basic implementation of the
[cw4 spec](./packages/cw4/README.md). It handles elected membership, by admin or multisig.
It fulfills all elements of the spec, including raw query lookups,
and is designed to be used as a backing storage for [cw3 compliant contracts](./packages/cw3/README.md).
* [`cw4-stake`](./contracts/cw4-stake) a second implementation of the
[cw4 spec](./packages/cw4/README.md). It fulfills all elements of the spec, including raw query lookups,
and is designed to be used as a backing storage for [cw3 compliant contracts](./packages/cw3/README.md).
It provides a similar API to [`cw4-group`], but rather than appointing members,
their membership and weight are based on the number of staked tokens they have.

CW20 Fungible Tokens:

* [`cw20-base`](./contracts/cw20-base) a straightforward, but complete
implementation of the cw20 spec along with all extensions. Can be deployed
as-is, or imported by other contracts.
* [`cw20-atomic-swap`](./contracts/cw20-atomic-swap) an implementation of atomic swaps for
both native and cw20 tokens.
* [`cw20-bonding`](./contracts/cw20-bonding) a smart contract implementing arbitrary bonding curves,
which can use native and cw20 tokens as reserve tokens.
* [`cw20-staking`](./contracts/cw20-staking) provides staking derivatives,
staking native tokens on your behalf and minting cw20 tokens that can
be used to claim them. It uses `cw20-base` for all the cw20 logic and
only implements the interactions with the staking module and accounting
for prices.
* [`cw20-escrow`](./contracts/cw20-escrow) is a basic escrow contract
(arbiter can release or refund tokens) that is compatible with all native
and cw20 tokens. This is a good example to show how to interact with
cw20 tokens.

* [`cw20-merkle-airdrop`](./contracts/cw20-merkle-airdrop) is a contract
  for efficient cw20 token airdrop distribution.

CW721 Non-fungible Tokens:

* [`cw721-base`](./contracts/cw721-base) a base implementation of a cw721 NFT contract.
It implements the [CW721 spec](./packages/cw721/README.md) and is designed to be deployed as is,
or imported into other contracts to easily build cw721-compatible NFTs with custom logic.

## Compiling

To compile all the contracts, run the following in the repo root:

```
docker run --rm -v "$(pwd)":/code \
  --mount type=volume,source="$(basename "$(pwd)")_cache",target=/code/target \
  --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry \
  cosmwasm/workspace-optimizer:0.11.3
```

This will compile all packages in the `contracts` directory and output the
stripped and optimized wasm code under the `artifacts` directory as output,
along with a `checksums.txt` file.

If you hit any issues there and want to debug, you can try to run the
following in each contract dir:
`RUSTFLAGS="-C link-arg=-s" cargo build --release --target=wasm32-unknown-unknown --locked`

## Quality Control

One of the basic metrics of assurance over code quality is how much is covered by
unit tests. There are several tools available for Rust to do such analysis and
we will describe one below. This should be used as a baseline metric to give some
confidence in the code.

Beyond code coverage metrics, just having a robust PR review process with a few
more trained eyes looking for bugs is very helpful in detecting paths the original
coder was not aware of. This is more subjective, but looking at the relevant PRs
and depth of discussion can give an idea how much review was present.

After that, fuzzing it (ideally with an intelligent fuzzer that understands the domain)
can be valuable. And beyond that formal verification can provide even more assurance
(but is very time consuming and expensive).

### Code Coverage

I recommend the use of [tarpaulin](https://github.com/xd009642/tarpaulin): `cargo install cargo-tarpaulin`

To get some nice interactive charts, you can go to the root directory and run:

`cargo tarpaulin -o html`
and then `xdg-open tarpaulin-report.html` (or just `open` on MacOS).

Once you find a package that you want to improve, you can do the following to just
analyze this package, which gives much faster turn-around:

`cargo tarpaulin -o html --packages cw3-fixed-multisig`

Note that it will produce a code coverage report for the entire project, but only the coverage in that
package is the real value. If does give quick feedback for you if you unit test writing was successful.

## Licenses

This repo contains two license, [Apache 2.0](./LICENSE-APACHE) and
[AGPL 3.0](./LICENSE-AGPL.md). All crates in this repo may be licensed
as one or the other. Please check the `NOTICE` in each crate or the
relevant `Cargo.toml` file for clarity.

All *specifications* will always be Apache-2.0. All contracts that are
meant to be *building blocks* will also be Apache-2.0. This is along
the lines of Open Zepellin or other public references.

Contracts that are "ready to deploy" may be licensed under AGPL 3.0 to
encourage anyone using them to contribute back any improvements they
make. This is common practice for actual projects running on Ethereum,
like Uniswap or Maker DAO.
